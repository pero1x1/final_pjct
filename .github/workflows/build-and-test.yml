name: build-and-test

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  build-test:
    # If your K8s API / registries are behind a closed SG, you may need a self-hosted runner.
    runs-on: ${{ vars.CI_RUNNER || 'ubuntu-latest' }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt -r requirements.api.txt
          pip install flake8 black "dvc[s3]" pip-audit

      - name: Dependency review (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4

      - name: Trivy FS scan (CRITICAL/HIGH)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true
          format: "table"
          exit-code: "1"

      - name: pip-audit (requirements)
        continue-on-error: true
        run: |
          pip-audit -r requirements.txt
          pip-audit -r requirements.api.txt

      - name: npm audit (frontend, if present)
        if: hashFiles('frontend/package.json') != ''
        continue-on-error: true
        run: |
          cd frontend
          npm install --no-audit --no-fund
          npm audit --audit-level=high

      - name: Lint (flake8) + format check (black)
        run: |
          flake8 src tests
          black --check src tests

      - name: Repro DVC pipeline (local)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          dvc repro
          dvc metrics show || true

      - name: Run tests (pytest)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: pytest -q
